name: Post release checklist

on:
  release:
    types: [published]

jobs:
  update_discussion:
    runs-on: ubuntu-latest
    permissions:
      discussions: write
      contents: read

    steps:
      - name: Update discussion table
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TITLE: ${{ github.event.release.name }}
          BODY: ${{ github.event.release.body }}
          DISCUSSION_TITLE: "ãƒªãƒªãƒ¼ã‚¹åæ˜ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ"
        run: |
          set -e
          OWNER="${REPO%/*}"
          NAME="${REPO#*/}"

          CUSTOMERS=("æ ªå¼ä¼šç¤¾A" "æ ªå¼ä¼šç¤¾B" "æ ªå¼ä¼šç¤¾C")

          echo "ğŸ” Repository: $OWNER/$NAME"

          # å¯¾è±¡Discussionã‚’å–å¾—
          DISCUSSION_JSON=$(gh api "repos/$OWNER/$NAME/discussions" --paginate)
          DISCUSSION_ID=$(echo "$DISCUSSION_JSON" | jq -r ".[] | select(.title==\"$DISCUSSION_TITLE\") | .node_id" | head -n 1)

          if [ -z "$DISCUSSION_ID" ]; then
            echo "âŒ Discussion not found: $DISCUSSION_TITLE"
            exit 1
          fi

          # ç¾åœ¨ã®æœ¬æ–‡ã‚’å–å¾—
          CURRENT_BODY=$(gh api graphql -f query='
            query($id: ID!) {
              node(id: $id) {
                ... on Discussion { body }
              }
            }' -f id="$DISCUSSION_ID" --jq '.data.node.body')

          # æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã‚ã‚‹ã‹ç¢ºèª
          if echo "$CURRENT_BODY" | grep -q '^| ãƒªãƒªãƒ¼ã‚¹å'; then
            echo "ğŸ§© æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¡Œã‚’è¿½åŠ ã—ã¾ã™"

            TABLE_HEADER=$(echo "$CURRENT_BODY" | grep -m1 '^| ãƒªãƒªãƒ¼ã‚¹å')
            SEPARATOR=$(echo "$CURRENT_BODY" | grep -m1 '^|[-]')
            EXISTING_ROWS=$(echo "$CURRENT_BODY" | grep -v '^| ãƒªãƒªãƒ¼ã‚¹å' | grep -v '^|[-]' || true)

            # æ–°ã—ã„ãƒªãƒªãƒ¼ã‚¹è¡Œã‚’ç”Ÿæˆï¼ˆãƒªãƒ³ã‚¯ä»˜ãï¼‰
            NEW_ROW="| [${TITLE}](https://github.com/${REPO}/releases/tag/${TITLE})"
            for _ in "${CUSTOMERS[@]}"; do
              NEW_ROW="${NEW_ROW} | â¬œ"
            done
            NEW_ROW="${NEW_ROW} |"

            # ãƒ†ãƒ¼ãƒ–ãƒ«ä»¥å¤–ã®æœ¬æ–‡éƒ¨åˆ†ã‚’æ®‹ã™
            PRE_TABLE_CONTENT=$(echo "$CURRENT_BODY" | sed '/^| ãƒªãƒªãƒ¼ã‚¹å/,$d')

            # printfã§å®Ÿä½“æ”¹è¡Œã«ã—ã¦çµ„ã¿ç«‹ã¦ï¼ˆEXISTING_ROWSãŒç©ºã§ã‚‚å®‰å…¨ï¼‰
            UPDATED_TABLE=$(printf "%s\n%s\n%s\n%s\n" \
              "$TABLE_HEADER" \
              "$SEPARATOR" \
              "$EXISTING_ROWS" \
              "$NEW_ROW")

            UPDATED_BODY=$(printf "%s\n%s\n" \
              "$PRE_TABLE_CONTENT" \
              "$UPDATED_TABLE")

          else
            echo "ğŸ†• æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã™"

            # ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            HEADER="| ãƒªãƒªãƒ¼ã‚¹å"
            for CUSTOMER in "${CUSTOMERS[@]}"; do
              HEADER="${HEADER} | ${CUSTOMER}"
            done
            HEADER="${HEADER} |"

            # åŒºåˆ‡ã‚Šè¡Œ
            SEPARATOR="|-------------"
            for _ in "${CUSTOMERS[@]}"; do
              SEPARATOR="${SEPARATOR}|------------"
            done
            SEPARATOR="${SEPARATOR}|"

            # æ–°ã—ã„è¡Œ
            NEW_ROW="| [${TITLE}](https://github.com/${REPO}/releases/tag/${TITLE})"
            for _ in "${CUSTOMERS[@]}"; do
              NEW_ROW="${NEW_ROW} | â¬œ"
            done
            NEW_ROW="${NEW_ROW} |"

            UPDATED_BODY=$(printf "%s\n\n%s\n%s\n%s\n" \
            "### ğŸ§¾ é¡§å®¢åˆ¥ãƒªãƒªãƒ¼ã‚¹åæ˜ çŠ¶æ³" \
            "$HEADER" \
            "$SEPARATOR" \
            "$NEW_ROW")
          fi

          # Discussionã‚’æ›´æ–°
          gh api graphql -f query='
            mutation($id: ID!, $body: String!) {
              updateDiscussion(input: {discussionId: $id, body: $body}) {
                discussion { url }
              }
            }' \
            -f id="$DISCUSSION_ID" \
            --raw-field body="$UPDATED_BODY"

          echo "âœ… Discussion updated successfully!"
