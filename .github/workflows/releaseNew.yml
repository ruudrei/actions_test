name: Post release checklist

on:
  release:
    types: [published]

jobs:
  update_discussion:
    runs-on: ubuntu-latest
    permissions:
      discussions: write
      contents: read

    steps:
      - name: Append release info to existing discussion
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TITLE: ${{ github.event.release.name }}
          BODY: ${{ github.event.release.body }}
          DISCUSSION_TITLE: "ãƒªãƒªãƒ¼ã‚¹åæ˜ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ"
        run: |
          set -e
          OWNER="${REPO%/*}"
          NAME="${REPO#*/}"

          echo "ğŸ” Repository: $OWNER/$NAME"

          # å¯¾è±¡ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—
          DISCUSSION_JSON=$(gh api "repos/$OWNER/$NAME/discussions" --paginate)
          DISCUSSION_ID=$(echo "$DISCUSSION_JSON" | jq -r ".[] | select(.title==\"$DISCUSSION_TITLE\") | .node_id" | head -n 1)

          if [ -z "$DISCUSSION_ID" ]; then
            echo "âŒ Discussion not found: $DISCUSSION_TITLE"
            exit 1
          fi

          # ç¾åœ¨ã®æœ¬æ–‡ã‚’å–å¾—
          CURRENT_BODY=$(gh api graphql -f query='
            query($id: ID!) {
              node(id: $id) {
                ... on Discussion { body }
              }
            }' -f id="$DISCUSSION_ID" --jq '.data.node.body')

          # æ–°ã—ã„ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆè¡Œã‚’æ§‹ç¯‰
          NEW_SECTION=$(cat <<EOF

          ---
          ### ğŸš€ ${TITLE}
          ${BODY}

          - [ ] æ ªå¼ä¼šç¤¾A
          - [ ] æ ªå¼ä¼šç¤¾B
          - [ ] æ ªå¼ä¼šç¤¾C

          > æ›´æ–°æ—¥: $(date '+%Y-%m-%d %H:%M')
          EOF
          )

          # æœ¬æ–‡ã‚’é€£çµ
          UPDATED_BODY="${CURRENT_BODY}${NEW_SECTION}"

          # Discussionã‚’æ›´æ–°
          gh api graphql -f query='
            mutation($id: ID!, $body: String!) {
              updateDiscussion(input: {discussionId: $id, body: $body}) {
                discussion { url }
              }
            }' \
            -f id="$DISCUSSION_ID" \
            -f body="$UPDATED_BODY"

          echo "âœ… Discussion updated successfully!"
