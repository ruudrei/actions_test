# name: Post release checklist

# on:
#   release:
#     types: [published]

# jobs:
#   create_discussion:
#     runs-on: ubuntu-latest
#     permissions:
#       discussions: write
#       contents: read

#     steps:
#       - name: Create Discussion with checklist
#         env:
#           GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#           REPO: ${{ github.repository }}
#           TITLE: ${{ github.event.release.name }}
#           BODY: ${{ github.event.release.body }}
#         run: |
#           # é¡§å®¢ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’å®šç¾©
#           CHECKLIST=$(cat <<'EOF'
#           | é¡§å®¢å | ç’°å¢ƒ | åæ˜ çŠ¶æ³ |
#           |--------|------|----------|
#           | æ ªå¼ä¼šç¤¾A | dev | â¬œ æœªç¢ºèª |
#           | æ ªå¼ä¼šç¤¾B | stg | â¬œ æœªç¢ºèª |
#           | æ ªå¼ä¼šç¤¾C | prod | â¬œ æœªç¢ºèª |
#           EOF
#           )

#           # Discussionæœ¬æ–‡ã‚’çµ„ã¿ç«‹ã¦ï¼ˆYAMLæ§‹æ–‡ã‚’å£Šã•ãªã„ã‚ˆã†å®‰å…¨ã«catã§ç”Ÿæˆï¼‰
#           BODY_COMBINED=$(cat <<EOF
#           ### ğŸ· ${TITLE} é–‹ç™ºç’°å¢ƒãƒªãƒªãƒ¼ã‚¹

#           #### ğŸ“‹ å¤‰æ›´å†…å®¹
#           ${BODY}

#           ---

#           #### ğŸ§¾ é¡§å®¢åˆ¥åæ˜ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
#           ${CHECKLIST}

#           > âœ… ãƒã‚§ãƒƒã‚¯ã¯æ‰‹å‹•ã§è¡Œã£ã¦ãã ã•ã„ã€‚
#           EOF
#           )

#           # ãƒªãƒã‚¸ãƒˆãƒªã¨ã‚«ãƒ†ã‚´ãƒªIDã‚’å–å¾—
#           REPO_ID=$(gh api graphql -f query='query { repository(owner: "'"${REPO%/*}"'", name: "'"${REPO#*/}"'") { id } }' --jq '.data.repository.id')

#           CATEGORY_ID=$(gh api graphql -f query='
#             query {
#               repository(owner: "'"${REPO%/*}"'", name: "'"${REPO#*/}"'") {
#                 discussionCategories(first: 10) {
#                   nodes { id name }
#                 }
#               }
#             }' --jq '.data.repository.discussionCategories.nodes[] | select(.name=="General") | .id')

#           # Discussionä½œæˆ
#           gh api graphql -f query='
#             mutation($repoId: ID!, $categoryId: ID!, $title: String!, $body: String!) {
#               createDiscussion(input: {
#                 repositoryId: $repoId,
#                 categoryId: $categoryId,
#                 title: $title,
#                 body: $body
#               }) {
#                 discussion { url }
#               }
#             }' \
#             -f repoId="$REPO_ID" \
#             -f categoryId="$CATEGORY_ID" \
#             -f title="$TITLE" \
#             -f body="$BODY_COMBINED"

name: Post release checklist

on:
  release:
    types: [published]

jobs:
  update_discussion:
    runs-on: ubuntu-latest
    permissions:
      discussions: write
      contents: read

    steps:
      - name: Update Discussion checklist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TITLE: ${{ github.event.release.name }}
          BODY: ${{ github.event.release.body }}
          DISCUSSION_TITLE: "ãƒªãƒªãƒ¼ã‚¹åæ˜ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ"
        run: |
          set -e

          OWNER="${REPO%/*}"
          NAME="${REPO#*/}"

          echo "ğŸ” Repository: $OWNER/$NAME"

          # æ—¢å­˜Discussionã‚’RESTã§å–å¾—
          DISCUSSION_JSON=$(gh api "repos/$OWNER/$NAME/discussions" --paginate)

          # ã‚¿ã‚¤ãƒˆãƒ«ä¸€è‡´ã§IDã¨æœ¬æ–‡ã‚’æŠ½å‡º
          DISCUSSION_ID=$(echo "$DISCUSSION_JSON" | jq -r ".[] | select(.title==\"$DISCUSSION_TITLE\") | .node_id" | head -n 1)
          DISCUSSION_BODY=$(echo "$DISCUSSION_JSON" | jq -r ".[] | select(.title==\"$DISCUSSION_TITLE\") | .body" | head -n 1)

          if [ "$DISCUSSION_ID" = "null" ] || [ -z "$DISCUSSION_ID" ]; then
            echo "âš ï¸ DiscussionãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€æ–°è¦ä½œæˆã—ã¾ã™ã€‚"

            CATEGORY_ID=$(gh api graphql -f query="query {
              repository(owner: \"$OWNER\", name: \"$NAME\") {
                discussionCategories(first: 10) {
                  nodes { id name }
                }
              }
            }" --jq '.data.repository.discussionCategories.nodes[0].id')

            BODY_INITIAL=$(cat <<EOF
            ## ğŸ§¾ ãƒªãƒªãƒ¼ã‚¹åæ˜ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

            | ãƒªãƒªãƒ¼ã‚¹å | æ ªå¼ä¼šç¤¾A (dev) | æ ªå¼ä¼šç¤¾B (stg) | æ ªå¼ä¼šç¤¾C (prod) |
            |-------------|----------------|----------------|----------------|
            EOF
            )

            DISCUSSION_URL=$(gh api graphql -f query="mutation(
              \$repoId: ID!, \$categoryId: ID!, \$title: String!, \$body: String!
            ) {
              createDiscussion(input: {
                repositoryId: \$repoId,
                categoryId: \$categoryId,
                title: \$title,
                body: \$body
              }) {
                discussion { url }
              }
            }" \
            -f repoId="$(gh api graphql -f query="query { repository(owner: \"$OWNER\", name: \"$NAME\") { id } }" --jq '.data.repository.id')" \
            -f categoryId="$CATEGORY_ID" \
            -f title="$DISCUSSION_TITLE" \
            -f body="$BODY_INITIAL" \
            --jq '.data.createDiscussion.discussion.url')

            echo "âœ… Created new Discussion: $DISCUSSION_URL"
            exit 0
          fi

          echo "âœ… Found existing Discussion ($DISCUSSION_ID)"

          # æ–°ã—ã„ãƒªãƒªãƒ¼ã‚¹è¡Œã‚’ä½œæˆ
          NEW_ROW="| ${TITLE} | â¬œ | â¬œ | â¬œ |"

          # æ—¢å­˜æœ¬æ–‡ã«è¿½è¨˜
          UPDATED_BODY="${DISCUSSION_BODY}\n${NEW_ROW}"

          # Discussionæ›´æ–°
          gh api graphql -f query="mutation(
            \$discussionId: ID!, \$body: String!
          ) {
            updateDiscussion(input: {
              discussionId: \$discussionId,
              body: \$body
            }) {
              discussion { url }
            }
          }" \
          -f discussionId="$DISCUSSION_ID" \
          -f body="$UPDATED_BODY"

          echo "ğŸ†• Added row for release: $TITLE"
