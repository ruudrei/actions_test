name: Post release checklist

on:
  release:
    types: [published]

jobs:
  create_discussion:
    runs-on: ubuntu-latest
    permissions:
      discussions: write
      contents: read

    steps:
      - name: Create Discussion with checklist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TITLE: ${{ github.event.release.name }}
          BODY: ${{ github.event.release.body }}
        run: |
          # é¡§å®¢ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’å®šç¾©
          CHECKLIST=$(cat <<'EOF'
          | é¡§å®¢å | ç’°å¢ƒ | åæ˜ çŠ¶æ³ |
          |--------|------|----------|
          | æ ªå¼ä¼šç¤¾A | dev | â¬œ æœªç¢ºèª |
          | æ ªå¼ä¼šç¤¾B | stg | â¬œ æœªç¢ºèª |
          | æ ªå¼ä¼šç¤¾C | prod | â¬œ æœªç¢ºèª |
          EOF
          )

          # Discussionæœ¬æ–‡ã‚’çµ„ã¿ç«‹ã¦ï¼ˆYAMLæ§‹æ–‡ã‚’å£Šã•ãªã„ã‚ˆã†å®‰å…¨ã«catã§ç”Ÿæˆï¼‰
          BODY_COMBINED=$(cat <<EOF
          ### ğŸ· ${TITLE} é–‹ç™ºç’°å¢ƒãƒªãƒªãƒ¼ã‚¹

          #### ğŸ“‹ å¤‰æ›´å†…å®¹
          ${BODY}

          ---

          #### ğŸ§¾ é¡§å®¢åˆ¥åæ˜ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
          ${CHECKLIST}

          > âœ… ãƒã‚§ãƒƒã‚¯ã¯æ‰‹å‹•ã§è¡Œã£ã¦ãã ã•ã„ã€‚
          EOF
          )

          # ãƒªãƒã‚¸ãƒˆãƒªã¨ã‚«ãƒ†ã‚´ãƒªIDã‚’å–å¾—
          REPO_ID=$(gh api graphql -f query='query { repository(owner: "'"${REPO%/*}"'", name: "'"${REPO#*/}"'") { id } }' --jq '.data.repository.id')

          CATEGORY_ID=$(gh api graphql -f query='
            query {
              repository(owner: "'"${REPO%/*}"'", name: "'"${REPO#*/}"'") {
                discussionCategories(first: 10) {
                  nodes { id name }
                }
              }
            }' --jq '.data.repository.discussionCategories.nodes[] | select(.name=="General") | .id')

          # Discussionä½œæˆ
          gh api graphql -f query='
            mutation($repoId: ID!, $categoryId: ID!, $title: String!, $body: String!) {
              createDiscussion(input: {
                repositoryId: $repoId,
                categoryId: $categoryId,
                title: $title,
                body: $body
              }) {
                discussion { url }
              }
            }' \
            -f repoId="$REPO_ID" \
            -f categoryId="$CATEGORY_ID" \
            -f title="$TITLE" \
            -f body="$BODY_COMBINED"
